{"pageProps":{"metaData":{"title":"ios拍照上传，照片被旋转","description":"ios,h5使用input拍照上传，上传之后的照片被旋转","tags":["ios","h5","exif"],"keywords":["ios","h5","exif"],"id":"IOS拍照上传内容被翻转","create":1689056521119,"lastUpdate":1692956372906},"content":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h1: \"h1\",\n    h3: \"h3\",\n    p: \"p\",\n    code: \"code\",\n    ul: \"ul\",\n    li: \"li\",\n    pre: \"pre\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"ios拍照,本地预览正常，上传之后被旋转\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"背景\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"H5使用input文件上传,本地预览正常，但是ios上传到后端之后，图片被旋转。搜索引擎一搜索，才知道这个涉及到到一个叫\", _jsx(_components.code, {\n        children: \"exif\"\n      }), \"(可交换图像文件格式)的东西\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"什么是exif\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Exif（Exchangeable image file format）也就是可交换图像文件格式。是专门用来\", _jsx(_components.code, {\n        children: \"记录数码照片属性信息和拍摄数据\"\n      }), \"。Exif信息包含了非常多的元数据，比如：\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"图像相关的有：图像ID、分辨率、分辨率单位、图像方向、图像宽高等\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"相机相关的有：相机制造商、相机型号、光圈值、焦距、物距、光圈值等\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"其他一些： 饱和度、亮度、清晰度、EXIF版本等\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"可能的问题\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"本地预览正常，上传被旋转\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"本地预览已经被旋转\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"解决方案\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"本地预览正常，上传被旋转\\n使用canvas重画照片(pass:本质就是去掉exif信息)\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-typescript\",\n        children: \"async function redrawImage(\\n  image: HTMLImageElement,\\n  fileName: string,\\n  fileType: string\\n): Promise<File> {\\n  const canvasDom = document.createElement(\\\"canvas\\\")\\n  canvasDom.width = image.width\\n  canvasDom.height = image.height\\n  const context = canvasDom.getContext(\\\"2d\\\")\\n  if (!context) throw new Error(\\\"canvas is null\\\")\\n  context.drawImage(image, 0, 0, image.naturalWidth, image.naturalHeight)\\n  const canvasDataURL = canvasDom.toDataURL(fileType, 0.7)\\n  return url2File(canvasDataURL, `${new Date().getTime()}${fileName}`)\\n}\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"本地预览图片已经被旋转\\n修改exif中图像方向信息\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-typescript\",\n        children: \"import piexif from \\\"piexifjs\\\"\\n/**\\n * 文件转dataUrl\\n */\\nfunction file2DataUrl(file: File) {\\n  return new Promise<string>(s => {\\n    let reader = new FileReader()\\n    reader.readAsDataURL(file)\\n    reader.onload = function (_e) {\\n      s(reader.result as string)\\n    }\\n  })\\n}\\n\\nasync function url2File(url: string, fileName: string):Promise<File> {\\n  const blob = await (await fetch(url)).blob()\\n  return new File([blob], fileName, { type: blob.type })\\n}\\n\\nasync function updateOrient(file: File) {\\n  const dataUrl = await file2DataUrl(file)\\n  let originExif = piexif.load(dataUrl) // 获取exif信息\\n  const orientation = originExif[\\\"0th\\\"][piexif.ImageIFD.Orientation] // orientation\\n  if (orientation && orientation != 1) {\\n    let exif = {}\\n    exif[piexif.ImageIFD.Orientation] = 3 // 设置orientation 这里需要根据实际情况将图片调整至你预期方向\\n    let exifObj = { \\\"0th\\\": exif }\\n    let exifbytes = piexif.dump(exifObj)\\n    let inserted = piexif.insert(exifbytes, dataUrl) // 写入新的exif\\n    return await url2File(inserted, `${new Date().getTime()}_${file.name}`)\\n  } else {\\n    return file\\n  }\\n}\\n\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"小结\"\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true}