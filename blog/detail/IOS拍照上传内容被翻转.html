<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>(*^▽^*)</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/80a95484ea2876e6.css" as="style"/><link rel="stylesheet" href="/_next/static/css/80a95484ea2876e6.css" data-n-g=""/><link rel="preload" href="/_next/static/css/f8f6338530cfd437.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f8f6338530cfd437.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-7477d36a73a3487c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d15f243f6b85624f.js" defer=""></script><script src="/_next/static/chunks/171-0943d13a71220321.js" defer=""></script><script src="/_next/static/chunks/pages/blog/detail/%5Bid%5D-0499978da9bd8e44.js" defer=""></script><script src="/_next/static/Hfiy8Coq2KP7oCRaNCVYV/_buildManifest.js" defer=""></script><script src="/_next/static/Hfiy8Coq2KP7oCRaNCVYV/_ssgManifest.js" defer=""></script><style id="__jsx-1471609662">.file-name-container.jsx-1471609662{display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;width:100%;max-width:100%;background-color:#1d2b35d9;padding:-webkit-calc(.5rem + .2vw);padding:-moz-calc(.5rem + .2vw);padding:calc(.5rem + .2vw);-webkit-border-top-left-radius:5px;-moz-border-radius-topleft:5px;border-top-left-radius:5px;-webkit-border-top-right-radius:5px;-moz-border-radius-topright:5px;border-top-right-radius:5px;margin-top:1vh;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word}.file-name.jsx-1471609662{font-family:"Share Tech Mono",monospace;font-size:-webkit-calc(.9rem + .1vw);font-size:-moz-calc(.9rem + .1vw);font-size:calc(.9rem + .1vw);color:#fffecbf2}</style></head><body><div id="__next"><div class="layout_main-container__jR90l"><main class="layout_main__E22hH"><div style="width:15em"><nav class="sidebar_nav__EFmKd"><div class="Avatar_container__egCID"><div class="Avatar_image-container__9WrGh"><img src="/images/avatar.png" alt="mingjianglong" class="Avatar_avatar__oORu6"/><h2>龙江</h2><h3 style="font-weight:normal;padding-top:.6em;color:grey">Jiang Long</h3><h4 style="padding-top:1.3em">等风也等你~</h4><span class="Avatar_my-face__hbhE_">ღゝ◡╹)ノ♡</span></div><div></div></div><a style="color:black" href="/">开心☺</a><a style="color:black" href="/blog">Blog</a><a style="color:black" href="/archive">归档</a><a style="color:black" href="/resume">简介</a></nav></div><div style="flex:1;height:100vh;display:flex;flex-direction:column;overflow-y:hidden"><div style="height:100%;padding:7em;overflow:scroll"><h1 style="font-family:&#x27;Ubuntu&#x27;, sans-serif;font-size:calc(1rem + 1.5vw);color:#1d2b35;padding:1em 0;overflow-wrap:break-word">ios拍照,本地预览正常，上传之后被旋转</h1>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;padding:.6em 0;overflow-wrap:break-word">背景</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">H5使用input文件上传,本地预览正常，但是ios上传到后端之后，图片被旋转。搜索引擎一搜索，才知道这个涉及到到一个叫<span class="SyntaxHighlighter_key-words__9bKIe">exif</span>(可交换图像文件格式)的东西</p>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;padding:.6em 0;overflow-wrap:break-word">什么是exif</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">Exif（Exchangeable image file format）也就是可交换图像文件格式。是专门用来<span class="SyntaxHighlighter_key-words__9bKIe">记录数码照片属性信息和拍摄数据</span>。Exif信息包含了非常多的元数据，比如：</p>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>图像相关的有：图像ID、分辨率、分辨率单位、图像方向、图像宽高等</li>
<li>相机相关的有：相机制造商、相机型号、光圈值、焦距、物距、光圈值等</li>
<li>其他一些： 饱和度、亮度、清晰度、EXIF版本等</li>
</ul>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;padding:.6em 0;overflow-wrap:break-word">可能的问题</h3>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>本地预览正常，上传被旋转</li>
<li>本地预览已经被旋转</li>
</ul>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;padding:.6em 0;overflow-wrap:break-word">解决方案</h3>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>本地预览正常，上传被旋转
使用canvas重画照片(pass:本质就是去掉exif信息)</li>
</ul>
<pre><pre class="language-typescript" style="color:#d4d4d4;font-size:calc(0.9rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e;background-color:#071013f2;margin-top:1vh;margin-bottom:1vh;border-radius:5px;padding-bottom:1em"><code class="language-typescript" style="color:#9cdcfe;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">redrawImage</span><span class="token" style="color:#d4d4d4">(</span><span>
</span><span>  image</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#4ec9b0">HTMLImageElement</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>  fileName</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">string</span><span class="token" style="color:#d4d4d4">,</span><span>
</span><span>  fileType</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">string</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token known-class-name" style="color:#4ec9b0">Promise</span><span class="token" style="color:#d4d4d4">&lt;</span><span class="token" style="color:#4ec9b0">File</span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">const</span><span> canvasDom </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token dom" style="color:#9cdcfe">document</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">createElement</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;canvas&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  canvasDom</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">width</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> image</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">width</span><span>
</span><span>  canvasDom</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">height</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> image</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">height</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">const</span><span> context </span><span class="token" style="color:#d4d4d4">=</span><span> canvasDom</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">getContext</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;2d&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span>context</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">throw</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token known-class-name" style="color:#4ec9b0">Error</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&quot;canvas is null&quot;</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  context</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">drawImage</span><span class="token" style="color:#d4d4d4">(</span><span>image</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">,</span><span> image</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">naturalWidth</span><span class="token" style="color:#d4d4d4">,</span><span> image</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">naturalHeight</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">const</span><span> canvasDataURL </span><span class="token" style="color:#d4d4d4">=</span><span> canvasDom</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">toDataURL</span><span class="token" style="color:#d4d4d4">(</span><span>fileType</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#b5cea8">0.7</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">url2File</span><span class="token" style="color:#d4d4d4">(</span><span>canvasDataURL</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#569CD6">new</span><span class="token template-string" style="color:#9cdcfe"> </span><span class="token template-string known-class-name" style="color:#4ec9b0">Date</span><span class="token template-string" style="color:#d4d4d4">(</span><span class="token template-string" style="color:#d4d4d4">)</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string method property-access" style="color:#dcdcaa">getTime</span><span class="token template-string" style="color:#d4d4d4">(</span><span class="token template-string" style="color:#d4d4d4">)</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">fileName</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></pre></pre>
<ul style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>本地预览图片已经被旋转
修改exif中图像方向信息</li>
</ul>
<pre><pre class="language-typescript" style="color:#d4d4d4;font-size:calc(0.9rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e;background-color:#071013f2;margin-top:1vh;margin-bottom:1vh;border-radius:5px;padding-bottom:1em"><code class="language-typescript" style="color:#9cdcfe;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#c586c0">import</span><span> </span><span class="token">piexif</span><span> </span><span class="token" style="color:#c586c0">from</span><span> </span><span class="token" style="color:#ce9178">&quot;piexifjs&quot;</span><span>
</span><span></span><span class="token doc-comment" style="color:#6a9955">/**
</span><span class="token doc-comment" style="color:#6a9955"> * 文件转dataUrl
</span><span class="token doc-comment" style="color:#6a9955"> */</span><span>
</span><span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">file2DataUrl</span><span class="token" style="color:#d4d4d4">(</span><span>file</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#4ec9b0">File</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token known-class-name" style="color:#4ec9b0">Promise</span><span class="token" style="color:#d4d4d4">&lt;</span><span class="token" style="color:#ce9178">string</span><span class="token" style="color:#d4d4d4">&gt;</span><span class="token" style="color:#d4d4d4">(</span><span>s </span><span class="token" style="color:#569CD6">=&gt;</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> reader </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">FileReader</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    reader</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">readAsDataURL</span><span class="token" style="color:#d4d4d4">(</span><span>file</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    reader</span><span class="token" style="color:#d4d4d4">.</span><span class="token method-variable function-variable method property-access" style="color:#dcdcaa">onload</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>_e</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#dcdcaa">s</span><span class="token" style="color:#d4d4d4">(</span><span>reader</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">result</span><span> </span><span class="token" style="color:#c586c0">as</span><span> </span><span class="token" style="color:#ce9178">string</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">url2File</span><span class="token" style="color:#d4d4d4">(</span><span>url</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">string</span><span class="token" style="color:#d4d4d4">,</span><span> fileName</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#ce9178">string</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">:</span><span class="token known-class-name" style="color:#4ec9b0">Promise</span><span class="token" style="color:#d4d4d4">&lt;</span><span class="token" style="color:#4ec9b0">File</span><span class="token" style="color:#d4d4d4">&gt;</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">const</span><span> blob </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">fetch</span><span class="token" style="color:#d4d4d4">(</span><span>url</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">blob</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">File</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">[</span><span>blob</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">,</span><span> fileName</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> type</span><span class="token" style="color:#d4d4d4">:</span><span> blob</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">type</span><span> </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
<span></span><span class="token" style="color:#569CD6">async</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">updateOrient</span><span class="token" style="color:#d4d4d4">(</span><span>file</span><span class="token" style="color:#d4d4d4">:</span><span> </span><span class="token" style="color:#4ec9b0">File</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">const</span><span> dataUrl </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">file2DataUrl</span><span class="token" style="color:#d4d4d4">(</span><span>file</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">let</span><span> originExif </span><span class="token" style="color:#d4d4d4">=</span><span> piexif</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">load</span><span class="token" style="color:#d4d4d4">(</span><span>dataUrl</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#6a9955">// 获取exif信息</span><span>
</span><span>  </span><span class="token" style="color:#569CD6">const</span><span> orientation </span><span class="token" style="color:#d4d4d4">=</span><span> originExif</span><span class="token" style="color:#d4d4d4">[</span><span class="token" style="color:#ce9178">&quot;0th&quot;</span><span class="token" style="color:#d4d4d4">]</span><span class="token" style="color:#d4d4d4">[</span><span>piexif</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access" style="color:#4ec9b0">ImageIFD</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access" style="color:#4ec9b0">Orientation</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#6a9955">// orientation</span><span>
</span><span>  </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>orientation </span><span class="token" style="color:#d4d4d4">&amp;&amp;</span><span> orientation </span><span class="token" style="color:#d4d4d4">!=</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> exif </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    exif</span><span class="token" style="color:#d4d4d4">[</span><span>piexif</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access" style="color:#4ec9b0">ImageIFD</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access" style="color:#4ec9b0">Orientation</span><span class="token" style="color:#d4d4d4">]</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#b5cea8">3</span><span> </span><span class="token" style="color:#6a9955">// 设置orientation 这里需要根据实际情况将图片调整至你预期方向</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> exifObj </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span> </span><span class="token string-property" style="color:#9cdcfe">&quot;0th&quot;</span><span class="token" style="color:#d4d4d4">:</span><span> exif </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> exifbytes </span><span class="token" style="color:#d4d4d4">=</span><span> piexif</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">dump</span><span class="token" style="color:#d4d4d4">(</span><span>exifObj</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> inserted </span><span class="token" style="color:#d4d4d4">=</span><span> piexif</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">insert</span><span class="token" style="color:#d4d4d4">(</span><span>exifbytes</span><span class="token" style="color:#d4d4d4">,</span><span> dataUrl</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#6a9955">// 写入新的exif</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#dcdcaa">url2File</span><span class="token" style="color:#d4d4d4">(</span><span>inserted</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#569CD6">new</span><span class="token template-string" style="color:#9cdcfe"> </span><span class="token template-string known-class-name" style="color:#4ec9b0">Date</span><span class="token template-string" style="color:#d4d4d4">(</span><span class="token template-string" style="color:#d4d4d4">)</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string method property-access" style="color:#dcdcaa">getTime</span><span class="token template-string" style="color:#d4d4d4">(</span><span class="token template-string" style="color:#d4d4d4">)</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string" style="color:#ce9178">_</span><span class="token template-string" style="color:#569cd6">${</span><span class="token template-string" style="color:#9cdcfe">file</span><span class="token template-string" style="color:#d4d4d4">.</span><span class="token template-string property-access" style="color:#9cdcfe">name</span><span class="token template-string" style="color:#569cd6">}</span><span class="token template-string template-punctuation" style="color:#ce9178">`</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">else</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> file
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span>
</code></pre></pre>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;padding:.6em 0;overflow-wrap:break-word">小结</h3></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metaData":{"title":"ios拍照上传，照片被旋转","description":"ios,h5使用input拍照上传，上传之后的照片被旋转","tags":["ios","h5","exif"],"keywords":["ios","h5","exif"],"id":"IOS拍照上传内容被翻转","create":1689056521119,"lastUpdate":1692955580362},"content":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h1: \"h1\",\n    h3: \"h3\",\n    p: \"p\",\n    code: \"code\",\n    ul: \"ul\",\n    li: \"li\",\n    pre: \"pre\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"ios拍照,本地预览正常，上传之后被旋转\"\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"背景\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"H5使用input文件上传,本地预览正常，但是ios上传到后端之后，图片被旋转。搜索引擎一搜索，才知道这个涉及到到一个叫\", _jsx(_components.code, {\n        children: \"exif\"\n      }), \"(可交换图像文件格式)的东西\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"什么是exif\"\n    }), \"\\n\", _jsxs(_components.p, {\n      children: [\"Exif（Exchangeable image file format）也就是可交换图像文件格式。是专门用来\", _jsx(_components.code, {\n        children: \"记录数码照片属性信息和拍摄数据\"\n      }), \"。Exif信息包含了非常多的元数据，比如：\"]\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"图像相关的有：图像ID、分辨率、分辨率单位、图像方向、图像宽高等\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"相机相关的有：相机制造商、相机型号、光圈值、焦距、物距、光圈值等\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"其他一些： 饱和度、亮度、清晰度、EXIF版本等\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"可能的问题\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"本地预览正常，上传被旋转\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"本地预览已经被旋转\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"解决方案\"\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"本地预览正常，上传被旋转\\n使用canvas重画照片(pass:本质就是去掉exif信息)\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-typescript\",\n        children: \"async function redrawImage(\\n  image: HTMLImageElement,\\n  fileName: string,\\n  fileType: string\\n): Promise\u003cFile\u003e {\\n  const canvasDom = document.createElement(\\\"canvas\\\")\\n  canvasDom.width = image.width\\n  canvasDom.height = image.height\\n  const context = canvasDom.getContext(\\\"2d\\\")\\n  if (!context) throw new Error(\\\"canvas is null\\\")\\n  context.drawImage(image, 0, 0, image.naturalWidth, image.naturalHeight)\\n  const canvasDataURL = canvasDom.toDataURL(fileType, 0.7)\\n  return url2File(canvasDataURL, `${new Date().getTime()}${fileName}`)\\n}\\n\"\n      })\n    }), \"\\n\", _jsxs(_components.ul, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"本地预览图片已经被旋转\\n修改exif中图像方向信息\"\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-typescript\",\n        children: \"import piexif from \\\"piexifjs\\\"\\n/**\\n * 文件转dataUrl\\n */\\nfunction file2DataUrl(file: File) {\\n  return new Promise\u003cstring\u003e(s =\u003e {\\n    let reader = new FileReader()\\n    reader.readAsDataURL(file)\\n    reader.onload = function (_e) {\\n      s(reader.result as string)\\n    }\\n  })\\n}\\n\\nasync function url2File(url: string, fileName: string):Promise\u003cFile\u003e {\\n  const blob = await (await fetch(url)).blob()\\n  return new File([blob], fileName, { type: blob.type })\\n}\\n\\nasync function updateOrient(file: File) {\\n  const dataUrl = await file2DataUrl(file)\\n  let originExif = piexif.load(dataUrl) // 获取exif信息\\n  const orientation = originExif[\\\"0th\\\"][piexif.ImageIFD.Orientation] // orientation\\n  if (orientation \u0026\u0026 orientation != 1) {\\n    let exif = {}\\n    exif[piexif.ImageIFD.Orientation] = 3 // 设置orientation 这里需要根据实际情况将图片调整至你预期方向\\n    let exifObj = { \\\"0th\\\": exif }\\n    let exifbytes = piexif.dump(exifObj)\\n    let inserted = piexif.insert(exifbytes, dataUrl) // 写入新的exif\\n    return await url2File(inserted, `${new Date().getTime()}_${file.name}`)\\n  } else {\\n    return file\\n  }\\n}\\n\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"小结\"\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true},"page":"/blog/detail/[id]","query":{"id":"IOS拍照上传内容被翻转"},"buildId":"Hfiy8Coq2KP7oCRaNCVYV","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>