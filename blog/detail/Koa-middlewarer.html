<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>文章详情</title><meta name="next-head-count" content="3"/><link rel="preload" href="/_next/static/css/3bf46ada9988a1ba.css" as="style"/><link rel="stylesheet" href="/_next/static/css/3bf46ada9988a1ba.css" data-n-g=""/><link rel="preload" href="/_next/static/css/f91c442bff8dce1b.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f91c442bff8dce1b.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ee7e63bc15b31913.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-7477d36a73a3487c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-71e28af04d8ee8d0.js" defer=""></script><script src="/_next/static/chunks/784-00c1e6d16e5c2f27.js" defer=""></script><script src="/_next/static/chunks/pages/blog/detail/%5Bid%5D-71e8e4fb74aa1a8a.js" defer=""></script><script src="/_next/static/Gxq2dyxPRzswZ35CPS9et/_buildManifest.js" defer=""></script><script src="/_next/static/Gxq2dyxPRzswZ35CPS9et/_ssgManifest.js" defer=""></script><style id="__jsx-1471609662">.file-name-container.jsx-1471609662{display:-webkit-box;display:-webkit-flex;display:-moz-box;display:-ms-flexbox;display:flex;width:100%;max-width:100%;background-color:#1d2b35d9;padding:-webkit-calc(.5rem + .2vw);padding:-moz-calc(.5rem + .2vw);padding:calc(.5rem + .2vw);-webkit-border-top-left-radius:5px;-moz-border-radius-topleft:5px;border-top-left-radius:5px;-webkit-border-top-right-radius:5px;-moz-border-radius-topright:5px;border-top-right-radius:5px;margin-top:1vh;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word}.file-name.jsx-1471609662{font-family:"Share Tech Mono",monospace;font-size:-webkit-calc(.9rem + .1vw);font-size:-moz-calc(.9rem + .1vw);font-size:calc(.9rem + .1vw);color:#fffecbf2}</style></head><body><div id="__next"><div class="layout_main-container__jR90l"><main class="layout_main__E22hH"><div style="width:15em"><nav class="sidebar_nav__EFmKd"><div class="Avatar_container__egCID"><div class="Avatar_image-container__9WrGh"><img src="/images/avatar.png" alt="mingjianglong" class="Avatar_avatar__oORu6"/><h2>龙江</h2><h3 style="font-weight:normal;padding-top:.6em;color:grey">Jiang Long</h3><h4 style="padding-top:1.3em">等风也等你~</h4><span class="Avatar_my-face__hbhE_">ღゝ◡╹)ノ♡</span></div><div></div></div><a style="color:red" href="/blog">Blog</a><a style="color:black" href="/archive">归档</a><a style="color:black" href="/resume">简介</a></nav></div><div style="flex:1;height:100vh;display:flex;flex-direction:column;overflow-y:hidden"><div style="height:100%;padding:7em;overflow:scroll"><h1 style="font-family:&#x27;Ubuntu&#x27;, sans-serif;font-size:calc(1rem + 1.5vw);color:#1d2b35;padding:1em 0;overflow-wrap:break-word">Koa 中间件</h1>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">搜索引擎一搜索koa中间件，大多都会谈及洋葱模型、next移交控制权。洋葱模型还能理解，可是next移交控制权听起来就很懵，所以抽空看了一下源码，看看怎么个移交法。</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">首先看了一下简单的执行顺序</p>
<ol style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013e6;margin:1vh 0 1vh calc(2vw);overflow-wrap:break-word">
<li>createServer:创建服务的时候,将callback的执行结果作为createServer的入参。</li>
<li>callback: 返回一个新的函数， 通过createContext将res和resp封装成context对象作为第一参数,并将compose的执行结果作为第二参数</li>
<li>compose函数第一个参数是callback创建的context,第二个参数一般都叫next,其实它就是<span class="SyntaxHighlighter_key-words__9bKIe">第i+1个中间件</span>，所以不要问为什么不执行next后面的中间件就不执行了</li>
</ol>
<pre><div class="jsx-1471609662"><div class="jsx-1471609662 file-name-container"><p class="jsx-1471609662 file-name">koa/lib/application.js</p></div><pre class="language-js:koa/lib/application.js" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1em;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-js" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#569CD6">class</span><span> </span><span class="token" style="color:#4ec9b0">Application</span><span> </span><span class="token" style="color:#569CD6">extends</span><span> </span><span class="token" style="color:#4ec9b0">Emitter</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#dcdcaa">use</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">fn</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">middleware</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">push</span><span class="token" style="color:#d4d4d4">(</span><span>fn</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#dcdcaa">callback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">const</span><span> fn </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#dcdcaa">compose</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">middleware</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">listenerCount</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;error&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">on</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;error&#x27;</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">onerror</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span>
<span>    </span><span class="token" style="color:#569CD6">const</span><span> </span><span class="token function-variable" style="color:#dcdcaa">handleRequest</span><span> </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">req</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> res</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">=&gt;</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#569CD6">const</span><span> ctx </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">createContext</span><span class="token" style="color:#d4d4d4">(</span><span>req</span><span class="token" style="color:#d4d4d4">,</span><span> res</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">ctxStorage</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">handleRequest</span><span class="token" style="color:#d4d4d4">(</span><span>ctx</span><span class="token" style="color:#d4d4d4">,</span><span> fn</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>      </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">ctxStorage</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">run</span><span class="token" style="color:#d4d4d4">(</span><span>ctx</span><span class="token" style="color:#d4d4d4">,</span><span> </span><span class="token" style="color:#569CD6">async</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#569CD6">=&gt;</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#c586c0">await</span><span> </span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">handleRequest</span><span class="token" style="color:#d4d4d4">(</span><span>ctx</span><span class="token" style="color:#d4d4d4">,</span><span> fn</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> handleRequest</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#dcdcaa">listen</span><span class="token" style="color:#d4d4d4">(</span><span class="token spread" style="color:#d4d4d4">...</span><span class="token" style="color:#9cdcfe">args</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#dcdcaa">debug</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;listen&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">const</span><span> server </span><span class="token" style="color:#d4d4d4">=</span><span> http</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">createServer</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">this</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">callback</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> server</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">listen</span><span class="token" style="color:#d4d4d4">(</span><span class="token spread" style="color:#d4d4d4">...</span><span>args</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></pre></div></pre>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">然后通过compose函数将各个中间件串联起来,compose函数会返回一个新的函数，入参为Context和Next，</p>
<pre><div class="jsx-1471609662"><div class="jsx-1471609662 file-name-container"><p class="jsx-1471609662 file-name">koa-compose/index.js</p></div><pre class="language-JS:koa-compose/index.js" style="color:#1d2b35;font-size:13px;text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0px;overflow:auto;background:#1e1e1e;background-color:#071013f2;padding-bottom:1em;margin-bottom:1vh;border-bottom-left-radius:5px;border-bottom-right-radius:5px"><code class="language-js" style="color:#d4d4d4;font-size:calc(0.8rem + 0.1vw);text-shadow:none;font-family:Menlo, Monaco, Consolas, &quot;Andale Mono&quot;, &quot;Ubuntu Mono&quot;, &quot;Courier New&quot;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.2;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token doc-comment" style="color:#6a9955">/**
</span><span class="token doc-comment" style="color:#6a9955"> * Compose `middleware` returning
</span><span class="token doc-comment" style="color:#6a9955"> * a fully valid middleware comprised
</span><span class="token doc-comment" style="color:#6a9955"> * of all those which are passed.
</span><span class="token doc-comment" style="color:#6a9955"> *
</span><span class="token doc-comment" style="color:#6a9955"> * </span><span class="token doc-comment" style="color:#569CD6">@param</span><span class="token doc-comment" style="color:#6a9955"> </span><span class="token doc-comment" style="color:#d4d4d4">{</span><span class="token doc-comment" style="color:#4ec9b0">Array</span><span class="token doc-comment" style="color:#d4d4d4">}</span><span class="token doc-comment" style="color:#6a9955"> </span><span class="token doc-comment" style="color:#9cdcfe">middleware</span><span class="token doc-comment" style="color:#6a9955">
</span><span class="token doc-comment" style="color:#6a9955"> * </span><span class="token doc-comment" style="color:#569CD6">@return</span><span class="token doc-comment" style="color:#6a9955"> </span><span class="token doc-comment" style="color:#d4d4d4">{</span><span class="token doc-comment" style="color:#4ec9b0">Function</span><span class="token doc-comment" style="color:#d4d4d4">}</span><span class="token doc-comment" style="color:#6a9955">
</span><span class="token doc-comment" style="color:#6a9955"> * </span><span class="token doc-comment" style="color:#569CD6">@api</span><span class="token doc-comment" style="color:#6a9955"> public
</span><span class="token doc-comment" style="color:#6a9955"> */</span><span>
</span><span></span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">compose</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">middleware</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>  </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">context</span><span class="token" style="color:#d4d4d4">,</span><span class="token" style="color:#9cdcfe"> next</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>    </span><span class="token" style="color:#6a9955">// last called middleware #</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">let</span><span> index </span><span class="token" style="color:#d4d4d4">=</span><span> </span><span class="token" style="color:#d4d4d4">-</span><span class="token" style="color:#b5cea8">1</span><span>
</span><span>    </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token" style="color:#dcdcaa">dispatch</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#b5cea8">0</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>    </span><span class="token" style="color:#569CD6">function</span><span> </span><span class="token" style="color:#dcdcaa">dispatch</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#9cdcfe">i</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>      </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>i </span><span class="token" style="color:#d4d4d4">&lt;=</span><span> index</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token known-class-name" style="color:#4ec9b0">Promise</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">reject</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#569CD6">new</span><span> </span><span class="token" style="color:#4ec9b0">Error</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#ce9178">&#x27;next() called multiple times&#x27;</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>      index </span><span class="token" style="color:#d4d4d4">=</span><span> i
</span><span>      </span><span class="token" style="color:#569CD6">let</span><span> fn </span><span class="token" style="color:#d4d4d4">=</span><span> middleware</span><span class="token" style="color:#d4d4d4">[</span><span>i</span><span class="token" style="color:#d4d4d4">]</span><span>
</span><span>      </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>i </span><span class="token" style="color:#d4d4d4">===</span><span> middleware</span><span class="token" style="color:#d4d4d4">.</span><span class="token property-access">length</span><span class="token" style="color:#d4d4d4">)</span><span> fn </span><span class="token" style="color:#d4d4d4">=</span><span> next
</span><span>      </span><span class="token" style="color:#c586c0">if</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">!</span><span>fn</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token known-class-name" style="color:#4ec9b0">Promise</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">resolve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>      </span><span class="token" style="color:#c586c0">try</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token known-class-name" style="color:#4ec9b0">Promise</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">resolve</span><span class="token" style="color:#d4d4d4">(</span><span class="token" style="color:#dcdcaa">fn</span><span class="token" style="color:#d4d4d4">(</span><span>context</span><span class="token" style="color:#d4d4d4">,</span><span> dispatch</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">bind</span><span class="token" style="color:#d4d4d4">(</span><span class="token null nil" style="color:#569CD6">null</span><span class="token" style="color:#d4d4d4">,</span><span> i </span><span class="token" style="color:#d4d4d4">+</span><span> </span><span class="token" style="color:#b5cea8">1</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">)</span><span class="token" style="color:#d4d4d4">;</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">}</span><span> </span><span class="token" style="color:#c586c0">catch</span><span> </span><span class="token" style="color:#d4d4d4">(</span><span>err</span><span class="token" style="color:#d4d4d4">)</span><span> </span><span class="token" style="color:#d4d4d4">{</span><span>
</span><span>        </span><span class="token" style="color:#c586c0">return</span><span> </span><span class="token known-class-name" style="color:#4ec9b0">Promise</span><span class="token" style="color:#d4d4d4">.</span><span class="token method property-access" style="color:#dcdcaa">reject</span><span class="token" style="color:#d4d4d4">(</span><span>err</span><span class="token" style="color:#d4d4d4">)</span><span>
</span><span>      </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>    </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span>  </span><span class="token" style="color:#d4d4d4">}</span><span>
</span><span></span><span class="token" style="color:#d4d4d4">}</span><span>
</span></code></pre></div></pre>
<h3 style="font-family:&#x27;Maven Pro&#x27;, sans-serif;font-size:calc(1rem + 0.5vw);color:#1d2b35;padding:.6em 0;overflow-wrap:break-word">总结</h3>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word">中间件的next就是中间件(通过compose将中间件串联起来的)就是按照注册顺序，当前中间的下一个中间件,所有的中间件的执行顺序可以参照asyncawait代码执行顺序。所以你要想你下一个中间件正常执行，你记得要调用下一个中间件(也就是next)</p>
<p style="font-family:&#x27;Source Sans Pro&#x27;, sans-serif;font-size:calc(1rem + 0.1vw);color:#071013f2;margin:0vh 0 1vh 0;overflow-wrap:break-word"><a style="color:#071013;text-decoration:none;cursor:pointer;border-bottom:1px dashed #fb232e;font-size:calc(1rem + 0.1vw);font-weight:bold;overflow-wrap:break-word" target="_blank" rel="noreferrer" href="https://github.com/koajs/koa/wiki#middleware">更多中间件</a></p></div></div></main></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"metaData":{"title":"Koa 中间件","description":"主要是简单看一下源码","tags":["Koa"],"keywords":["Koa"],"id":"Koa-middlewarer","create":1682651966530,"lastUpdate":1684470557887},"content":{"compiledSource":"/*@jsxRuntime automatic @jsxImportSource react*/\nconst {Fragment: _Fragment, jsx: _jsx, jsxs: _jsxs} = arguments[0];\nconst {useMDXComponents: _provideComponents} = arguments[0];\nfunction _createMdxContent(props) {\n  const _components = Object.assign({\n    h1: \"h1\",\n    p: \"p\",\n    ol: \"ol\",\n    li: \"li\",\n    code: \"code\",\n    pre: \"pre\",\n    h3: \"h3\",\n    a: \"a\"\n  }, _provideComponents(), props.components);\n  return _jsxs(_Fragment, {\n    children: [_jsx(_components.h1, {\n      children: \"Koa 中间件\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"搜索引擎一搜索koa中间件，大多都会谈及洋葱模型、next移交控制权。洋葱模型还能理解，可是next移交控制权听起来就很懵，所以抽空看了一下源码，看看怎么个移交法。\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"首先看了一下简单的执行顺序\"\n    }), \"\\n\", _jsxs(_components.ol, {\n      children: [\"\\n\", _jsx(_components.li, {\n        children: \"createServer:创建服务的时候,将callback的执行结果作为createServer的入参。\"\n      }), \"\\n\", _jsx(_components.li, {\n        children: \"callback: 返回一个新的函数， 通过createContext将res和resp封装成context对象作为第一参数,并将compose的执行结果作为第二参数\"\n      }), \"\\n\", _jsxs(_components.li, {\n        children: [\"compose函数第一个参数是callback创建的context,第二个参数一般都叫next,其实它就是\", _jsx(_components.code, {\n          children: \"第i+1个中间件\"\n        }), \"，所以不要问为什么不执行next后面的中间件就不执行了\"]\n      }), \"\\n\"]\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-js:koa/lib/application.js\",\n        children: \"class Application extends Emitter {\\n  use(fn) {\\n    this.middleware.push(fn);\\n    return this;\\n  }\\n  callback() {\\n    const fn = compose(this.middleware);\\n\\n    if (!this.listenerCount('error')) this.on('error', this.onerror);\\n\\n    const handleRequest = (req, res) =\u003e {\\n      const ctx = this.createContext(req, res);\\n      if (!this.ctxStorage) {\\n        return this.handleRequest(ctx, fn);\\n      }\\n      return this.ctxStorage.run(ctx, async() =\u003e {\\n        return await this.handleRequest(ctx, fn);\\n      });\\n    };\\n    return handleRequest;\\n  }\\n  listen(...args) {\\n    debug('listen');\\n    const server = http.createServer(this.callback());\\n    return server.listen(...args);\\n  }\\n}\\n\"\n      })\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"然后通过compose函数将各个中间件串联起来,compose函数会返回一个新的函数，入参为Context和Next，\"\n    }), \"\\n\", _jsx(_components.pre, {\n      children: _jsx(_components.code, {\n        className: \"language-JS:koa-compose/index.js\",\n        children: \"/**\\n * Compose `middleware` returning\\n * a fully valid middleware comprised\\n * of all those which are passed.\\n *\\n * @param {Array} middleware\\n * @return {Function}\\n * @api public\\n */\\nfunction compose (middleware) {\\n  return function (context, next) {\\n    // last called middleware #\\n    let index = -1\\n    return dispatch(0)\\n    function dispatch (i) {\\n      if (i \u003c= index) return Promise.reject(new Error('next() called multiple times'))\\n      index = i\\n      let fn = middleware[i]\\n      if (i === middleware.length) fn = next\\n      if (!fn) return Promise.resolve()\\n      try {\\n        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));\\n      } catch (err) {\\n        return Promise.reject(err)\\n      }\\n    }\\n  }\\n}\\n\"\n      })\n    }), \"\\n\", _jsx(_components.h3, {\n      children: \"总结\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: \"中间件的next就是中间件(通过compose将中间件串联起来的)就是按照注册顺序，当前中间的下一个中间件,所有的中间件的执行顺序可以参照asyncawait代码执行顺序。所以你要想你下一个中间件正常执行，你记得要调用下一个中间件(也就是next)\"\n    }), \"\\n\", _jsx(_components.p, {\n      children: _jsx(_components.a, {\n        href: \"https://github.com/koajs/koa/wiki#middleware\",\n        children: \"更多中间件\"\n      })\n    })]\n  });\n}\nfunction MDXContent(props = {}) {\n  const {wrapper: MDXLayout} = Object.assign({}, _provideComponents(), props.components);\n  return MDXLayout ? _jsx(MDXLayout, Object.assign({}, props, {\n    children: _jsx(_createMdxContent, props)\n  })) : _createMdxContent(props);\n}\nreturn {\n  default: MDXContent\n};\n","frontmatter":{},"scope":{}}},"__N_SSG":true},"page":"/blog/detail/[id]","query":{"id":"Koa-middlewarer"},"buildId":"Gxq2dyxPRzswZ35CPS9et","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>