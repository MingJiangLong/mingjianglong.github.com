---
title: Koa 中间件
description: 主要是简单看一下源码
tags:
  - Koa
keywords:
  - Koa
id: Koa-middlewarer
create: 1682651966530
lastUpdate: 1682652063334
---
# Koa 中间件

搜索引擎一搜索koa中间件，大多都会谈及洋葱模型、next移交控制权。洋葱模型还能理解，可是next移交控制权听起来就很懵，所以抽空看了一下源码，看看怎么个移交法。

首先看了一下简单的执行顺序
1. createServer:创建服务的时候,将callback的执行结果作为createServer的入参。
2. callback: 返回一个新的函数， 通过createContext将res和resp封装成context对象作为第一参数,并将compose的执行结果作为第二参数
3. compose函数第一个参数是callback创建的context,第二个参数一般都叫next,其实它就是`第i+1个中间件`，所以不要问为什么不执行next后面的中间件就不执行了

```js:koa/lib/application.js
class Application extends Emitter {
  use(fn) {
    this.middleware.push(fn);
    return this;
  }
  callback() {
    const fn = compose(this.middleware);

    if (!this.listenerCount('error')) this.on('error', this.onerror);

    const handleRequest = (req, res) => {
      const ctx = this.createContext(req, res);
      if (!this.ctxStorage) {
        return this.handleRequest(ctx, fn);
      }
      return this.ctxStorage.run(ctx, async() => {
        return await this.handleRequest(ctx, fn);
      });
    };
    return handleRequest;
  }
  listen(...args) {
    debug('listen');
    const server = http.createServer(this.callback());
    return server.listen(...args);
  }
}
```

然后通过compose函数将各个中间件串联起来,compose函数会返回一个新的函数，入参为Context和Next，

```JS:koa-compose/index.js
/**
 * Compose `middleware` returning
 * a fully valid middleware comprised
 * of all those which are passed.
 *
 * @param {Array} middleware
 * @return {Function}
 * @api public
 */
function compose (middleware) {
  return function (context, next) {
    // last called middleware #
    let index = -1
    return dispatch(0)
    function dispatch (i) {
      if (i <= index) return Promise.reject(new Error('next() called multiple times'))
      index = i
      let fn = middleware[i]
      if (i === middleware.length) fn = next
      if (!fn) return Promise.resolve()
      try {
        return Promise.resolve(fn(context, dispatch.bind(null, i + 1)));
      } catch (err) {
        return Promise.reject(err)
      }
    }
  }
}
```

### 总结
   中间件的next就是中间件(通过compose将中间件串联起来的)就是按照注册顺序，当前中间的下一个中间件,所有的中间件的执行顺序可以参照asyncawait代码执行顺序。所以你要想你下一个中间件正常执行，你记得要调用下一个中间件(也就是next)

[更多中间件](https://github.com/koajs/koa/wiki#middleware)







